
CREATE DATABASE `CAR_LOCA` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;



-- CAR_LOCA.CARRO definition

CREATE TABLE `CARRO` (
  `ID` int NOT NULL AUTO_INCREMENT,
  `MODELO` varchar(100) NOT NULL,
  `MONTADORA` varchar(100) NOT NULL,
  `COR` enum('PRETO','PRATA','BRANCO') CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `VERSAO` varchar(100) NOT NULL,
  `ID_CATEGORIA` int NOT NULL,
  `KILOMETRAGEM` int NOT NULL,
  `DISPONIVEL` tinyint(1) NOT NULL,
  PRIMARY KEY (`ID`),
  KEY `CARRO_FK` (`ID_CATEGORIA`),
  CONSTRAINT `CARRO_FK` FOREIGN KEY (`ID_CATEGORIA`) REFERENCES `CATEGORIA` (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;



-- CAR_LOCA.CATEGORIA definition

CREATE TABLE `CATEGORIA` (
  `ID` int NOT NULL AUTO_INCREMENT,
  `NOME` varchar(100) NOT NULL,
  `DIARIA` float NOT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;



-- CAR_LOCA.CLIENTE definition

CREATE TABLE `CLIENTE` (
  `ID` int NOT NULL AUTO_INCREMENT,
  `NOME` varchar(100) NOT NULL,
  `CPF` varchar(100) NOT NULL,
  `CNH` varchar(100) NOT NULL,
  `ID_ENDERECO` int NOT NULL,
  PRIMARY KEY (`ID`),
  KEY `CLIENTE_FK` (`ID_ENDERECO`),
  CONSTRAINT `CLIENTE_FK` FOREIGN KEY (`ID_ENDERECO`) REFERENCES `ENDERECO` (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;



-- CAR_LOCA.ENDERECO definition

CREATE TABLE `ENDERECO` (
  `ID` int NOT NULL AUTO_INCREMENT,
  `LOGRADOURO` varchar(100) NOT NULL,
  `CEP` varchar(9) NOT NULL,
  `NUMERO` varchar(10) NOT NULL,
  `BAIRRO` varchar(100) NOT NULL,
  `CIDADE` varchar(100) NOT NULL,
  `ESTADO` varchar(100) NOT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;



-- CAR_LOCA.FRANQUIA definition

CREATE TABLE `FRANQUIA` (
  `ID` int NOT NULL AUTO_INCREMENT,
  `ID_ENDERECO` int NOT NULL,
  PRIMARY KEY (`ID`),
  KEY `FILIAIS_FK` (`ID_ENDERECO`),
  CONSTRAINT `FILIAIS_FK` FOREIGN KEY (`ID_ENDERECO`) REFERENCES `ENDERECO` (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;



-- CAR_LOCA.LOCACAO definition

CREATE TABLE `LOCACAO` (
  `ID` int NOT NULL AUTO_INCREMENT,
  `ID_CARRO` int NOT NULL,
  `ID_CLIENTE` int NOT NULL,
  `DATA` date NOT NULL,
  `ID_FRANQUIA` int NOT NULL,
  PRIMARY KEY (`ID`),
  KEY `CARRO_CLIENTE_FK` (`ID_CARRO`),
  KEY `CARRO_CLIENTE_FK_1` (`ID_CLIENTE`),
  KEY `LOCACAO_FK` (`ID_FRANQUIA`),
  CONSTRAINT `CARRO_CLIENTE_FK` FOREIGN KEY (`ID_CARRO`) REFERENCES `CARRO` (`ID`),
  CONSTRAINT `CARRO_CLIENTE_FK_1` FOREIGN KEY (`ID_CLIENTE`) REFERENCES `CLIENTE` (`ID`),
  CONSTRAINT `LOCACAO_FK` FOREIGN KEY (`ID_FRANQUIA`) REFERENCES `FRANQUIA` (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE DEFINER=`root`@`%` TRIGGER `ATUALIZAR_DISPONIBILIDADE` AFTER INSERT ON `LOCACAO` FOR EACH ROW BEGIN
	UPDATE CARRO SET DISPONIVEL = 0 WHERE CARRO.ID = NEW.ID_CARRO;
END;



-- CAR_LOCA.DEVOLUCAO definition

CREATE TABLE `DEVOLUCAO` (
  `ID` int NOT NULL AUTO_INCREMENT,
  `ID_LOCACAO` int NOT NULL,
  `DATA_FIM` date NOT NULL,
  `ID_FRANQUIA` int NOT NULL,
  `KM_RODADO` int NOT NULL,
  PRIMARY KEY (`ID`),
  KEY `DEVOLUCAO_FK` (`ID_LOCACAO`),
  KEY `DEVOLUCAO_FK_1` (`ID_FRANQUIA`),
  CONSTRAINT `DEVOLUCAO_FK` FOREIGN KEY (`ID_LOCACAO`) REFERENCES `LOCACAO` (`ID`),
  CONSTRAINT `DEVOLUCAO_FK_1` FOREIGN KEY (`ID_FRANQUIA`) REFERENCES `FRANQUIA` (`ID`)
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE DEFINER=`root`@`%` TRIGGER `ATUALIZAR_KM` AFTER INSERT ON `DEVOLUCAO` FOR EACH ROW BEGIN
	SET @ID_CARRO := (SELECT ID_CARRO FROM LOCACAO l WHERE l.ID = NEW.ID_LOCACAO);
	UPDATE CARRO SET KILOMETRAGEM = CARRO.KILOMETRAGEM + NEW.KM_RODADO WHERE CARRO.ID = @ID_CARRO;
END;

CREATE DEFINER=`root`@`%` TRIGGER `ATUALIZAR_DISPONIBILIDADE2` AFTER INSERT ON `DEVOLUCAO` FOR EACH ROW BEGIN
	SET @ID_CARRO := (SELECT ID_CARRO FROM LOCACAO l WHERE l.ID = NEW.ID_LOCACAO);
	UPDATE CARRO SET DISPONIVEL = 1 WHERE CARRO.ID = @ID_CARRO;
END;

